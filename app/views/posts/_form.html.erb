<section class="S_postForm">
  <div class="W_postFormBack">
    <button class="Q_back" onclick="history.back()">
      <img src="<%= asset_path('backArrowIcon_b.svg') %>" alt="–°—Ç—Ä–µ–ª–∫–∞ –Ω–∞–∑–∞–¥">
    </button>
  </div>
  
  <% if @post.persisted? && @post.items.any? %>
    <script>
      window.existingItems = <%= raw(@post.items.to_json(only: [:id, :name, :price, :purchase_url, :image_url])) %>;
    </script>
  <% else %>
    <script>
      window.existingItems = [];
    </script>
  <% end %>


  <%= form_with(model: @post, html: { class: "O_postForm" }) do |form| %>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–æ—Å—Ç–∞ -->
    <div class="M_uploadPostImg">
      <label for="post_image_upload" class="A_uploadPostPreview">
        <% if @post.image_url.present? %>
          <img src="<%= @post.image_url %>" alt="–ü—Ä–µ–≤—å—é" class="Q_postImgUpload" />
        <% else %>
          <div class="Q_plusImg placeholder">
            <img src="<%= asset_path('plusImgIcon_w.svg') %>" alt="–ü–ª—é—Å–∏–∫">
          </div>
          <h4 class="placeholder">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ —Å—é–¥–∞</h4>
          <img src="" alt="–ü—Ä–µ–≤—å—é" class="Q_postImgUpload hidden" />
        <% end %>
      </label>
      <%= form.file_field :image_url, id: "post_image_upload", class: "hidden" %>
    </div>

    <div class="W_formPostDetails">
      <div class="C_formPostDetails">

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ -->
        <div class="M_formPostAddInfo">
          <h1>–û—Å–Ω–æ–≤–Ω–æ–µ</h1>
          <div>
            <%= form.text_field :title, class: "Q_formPostTitle", id: "post_title", placeholder: "–ó–∞–≥–æ–ª–æ–≤–æ–∫" %>
            <%= form.text_field :description, class: "Q_formPostDesc", id: "post_description", placeholder: "–û–ø–∏—Å–∞–Ω–∏–µ" %>
          </div>
        </div>

        <!-- –¢–µ–≥–∏ -->
        <div class="M_formPostAddInfo">
          <h1>–¢–µ–≥–∏</h1>
          <button type="button" class="A_addTagsBtn">
            <h4>–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏</h4>
            <img src="<%= asset_path('crossIcon_b.svg') %>" alt="–ü–ª—é—Å–∏–∫/–ö—Ä–µ—Å—Ç–∏–∫">
          </button>

          <% selected_tags = @post.tag_list || [] %>

          <div class="C_tagsList hidden">
            <% TagCategory.includes(:tags).each do |category| %>
              <div class="W_tagsByCattegory">
                <h3 class="Q_cattegoryName"><%= category.name %></h3>
                <div class="C_newPostTags">
                  <% category.tags.each do |tag| %>
                    <% selected = selected_tags.include?(tag.name) %>
                    <button type="button" class="Q_tagBtn <%= 'selected' if selected %>" data-tag="<%= tag.name %>" data-selected="<%= selected %>">
                      <%= tag.name %>
                    </button>
                  <% end %>
                </div>
              </div>
            <% end %>
            <input type="hidden" name="post[tag_list]" id="post_tag_list" value="<%= selected_tags.join(',') %>">
          </div>
        </div>

        <!-- üõí –¢–æ–≤–∞—Ä—ã -->
        <div class="M_formPostAddInfo">
          <h1>–¢–æ–≤–∞—Ä—ã</h1>
          <div class="A_formItemsToggle">
            <h4 class="active">–ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</h4>
            <h4>–°–æ–∑–¥–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä</h4>
          </div>

          <div class="C_itemsList" id="items-list">
            <!-- –ò–Ω–ø—É—Ç —Å—Å—ã–ª–∫–∏ -->
            <div class="A_addItemInput">
              <%= text_field_tag :item_link, nil, placeholder: "–°—Å—ã–ª–∫–∞", class: "Q_addItemLinkInput" %>
              <button type="button" class="Q_findItem"><h4>–ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</h4></button>
            </div>

            <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã, –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
            <%= render partial: "items/item_form", collection: @post.items, as: :item %>
          </div>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <div class="C_formPostBtns">
        <%= hidden_field_tag "post[temp_items_json]", "", id: "temp_items_json" %>
        <%= form.submit "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", class: "Q_publishPostBtn submit", disabled: true, data: { action: "form#submit" } %>
      </div>
    </div>

  <% end %>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (—Ñ–æ—Ä–º–∞) -->
  <%= render partial: "items/form", locals: { item: Item.new } %>
</section>
